---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import AdPlaceholder from '../../components/AdPlaceholder.astro';
import Badge from '../../components/Badge.astro';
import { getCollection } from 'astro:content';
import { getCategoryName, getCategoryColor } from '../../data/categories';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === post.data.category)
  .slice(0, 3);

const formattedDate = post.data.date.toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Use tags from frontmatter, fallback to category if no tags
const tags = post.data.tags && post.data.tags.length > 0
  ? post.data.tags
  : [getCategoryName(post.data.category)];
---

<Layout title={`${post.data.title} - LaHora24`} description={post.data.excerpt}>
  <Header />

  <!-- ===================== POST HERO ===================== -->
  <section class="post-hero">
    <img src={post.data.image} alt={post.data.title} class="post-hero__image" />
    <div class="post-hero__overlay">
      <div class="post-hero__container">
        <a href={`/categoria/${post.data.category}`} class="badge" style={`background-color: ${getCategoryColor(post.data.category)};`}>
          {getCategoryName(post.data.category)}
        </a>
        <h1 class="post-hero__title">{post.data.title}</h1>
        <div class="post-hero__meta">
          <div class="post-hero__author">
            {post.data.authorAvatar ? (
              <img src={post.data.authorAvatar} alt={post.data.author} class="post-hero__author-avatar post-hero__author-avatar--img" />
            ) : (
              <div class="post-hero__author-avatar">{post.data.author.charAt(0)}</div>
            )}
            <span>{post.data.author}</span>
          </div>
          <span class="post-hero__separator">•</span>
          <span>{formattedDate}</span>
          <span class="post-hero__separator">•</span>
          <span>{post.data.readTime} de lectura</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== POST CONTENT ===================== -->
  <div class="post-layout">
    <article class="post-article">
      <div class="post-article__body prose">
        <Content />
      </div>
    </article>

    <!-- Sidebar -->
    <aside class="post-sidebar">
      <div class="author-card">
        {post.data.authorAvatar ? (
          <img src={post.data.authorAvatar} alt={post.data.author} class="author-card__avatar author-card__avatar--img" />
        ) : (
          <div class="author-card__avatar">{post.data.author.charAt(0)}</div>
        )}
        <h3 class="author-card__name">{post.data.author}</h3>
        {post.data.authorRole && <p class="author-card__role">{post.data.authorRole}</p>}
        <div class="author-card__socials">
          <a href="#" aria-label="Twitter">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4l11.733 16h4.267l-11.733 -16h-4.267z"/><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"/></svg>
          </a>
          <a href="#" aria-label="LinkedIn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-4 0v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
          </a>
          <a href="#" aria-label="Email">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          </a>
        </div>
      </div>

      <!-- Table of Contents -->
      <div class="toc-card">
        <h4 class="toc-card__title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          En este artículo
        </h4>
        <nav class="toc-card__nav" id="tableOfContents"></nav>
      </div>

      <!-- AD: Sidebar -->
      <AdPlaceholder slot="post-sidebar" size="rectangle" />
    </aside>
  </div>

  <!-- AD: After Content -->
  <div class="container" style="max-width: 900px; margin: 2rem auto;">
    <AdPlaceholder slot="post-after-content" size="in-article" />
  </div>

  <!-- ===================== POST FOOTER ===================== -->
  <div class="post-footer">
    <div class="post-footer__inner">
      <div class="post-tags">
        {tags.map((tag: string) => <a href="#" class="post-tag">{tag}</a>)}
      </div>
      <div class="post-share">
        <span class="post-share__label">Compartir:</span>
        <div class="post-share__buttons">
          <button class="post-share__btn" aria-label="Compartir en Twitter" data-share="twitter">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4l11.733 16h4.267l-11.733 -16h-4.267z"/><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"/></svg>
          </button>
          <button class="post-share__btn" aria-label="Compartir en LinkedIn" data-share="linkedin">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-4 0v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
          </button>
          <button class="post-share__btn" aria-label="Copiar enlace" data-share="copy">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AD: Before Related Articles -->
  <div class="container" style="max-width: 1200px; margin: 2rem auto;">
    <AdPlaceholder slot="post-before-related" size="leaderboard" />
  </div>

  <!-- ===================== RELATED ARTICLES ===================== -->
  {relatedPosts.length > 0 && (
    <section class="related-articles">
      <div class="container">
        <h2 class="related-articles__title">Artículos Relacionados</h2>
        <div class="related-articles__grid">
          {relatedPosts.map(relatedPost => <PostCard post={relatedPost} />)}
        </div>
      </div>
    </section>
  )}

  <Footer />
</Layout>

<style>
  /* ===================== POST HERO ===================== */
  .post-hero {
    position: relative;
    height: 70vh;
    min-height: 500px;
    max-height: 700px;
    overflow: hidden;
  }

  .post-hero__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-hero__overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.95) 0%,
      rgba(0, 0, 0, 0.6) 40%,
      rgba(0, 0, 0, 0.2) 70%,
      transparent 100%
    );
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
  }

  .post-hero__container {
    width: 100%;
    max-width: 1200px;
    padding: 4rem 2rem;
    margin: 0 auto;
  }

  .post-hero__container > * {
    max-width: 800px;
  }

  .post-hero__title {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 700;
    color: #fff;
    line-height: 1.15;
    margin-top: 1rem;
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
  }

  .post-hero__meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
    color: rgba(255, 255, 255, 0.85);
    font-size: 0.95rem;
    flex-wrap: wrap;
  }

  .post-hero__separator {
    opacity: 0.5;
  }

  .post-hero__author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .post-hero__author-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-accent) 0%, #6366f1 100%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .post-hero__author-avatar--img {
    object-fit: cover;
    background: none;
  }

  /* ===================== POST LAYOUT ===================== */
  .post-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 4rem;
    max-width: 1200px;
    margin: 0 auto;
    padding: 4rem 2rem;
  }

  .post-article {
    min-width: 0;
  }

  .post-article__body {
    font-size: 1.125rem;
    line-height: 1.85;
    color: var(--color-text);
  }

  /* Prose styles */
  .post-article__body :global(p) {
    margin-bottom: 1.75rem;
  }

  .post-article__body :global(p:first-of-type) {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
    line-height: 1.7;
  }

  .post-article__body :global(h2) {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    font-weight: 700;
    margin: 3rem 0 1.25rem;
    color: var(--color-text);
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-border);
  }

  .post-article__body :global(h3) {
    font-family: var(--font-heading);
    font-size: 1.35rem;
    font-weight: 600;
    margin: 2rem 0 1rem;
    color: var(--color-text);
  }

  .post-article__body :global(blockquote) {
    position: relative;
    background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-alt) 100%);
    border-left: 4px solid var(--color-accent);
    padding: 2rem 2rem 2rem 2.5rem;
    margin: 2.5rem 0;
    border-radius: 0 var(--card-radius) var(--card-radius) 0;
    font-size: 1.15rem;
    font-style: italic;
    color: var(--color-text-secondary);
  }

  .post-article__body :global(blockquote::before) {
    content: '"';
    position: absolute;
    top: -10px;
    left: 15px;
    font-size: 4rem;
    color: var(--color-accent);
    opacity: 0.3;
    font-family: Georgia, serif;
  }

  .post-article__body :global(blockquote p:last-child) {
    margin-bottom: 0;
  }

  .post-article__body :global(pre) {
    background: #0f172a;
    color: #e2e8f0;
    padding: 1.75rem;
    border-radius: var(--card-radius);
    overflow-x: auto;
    font-family: 'Fira Code', 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.7;
    margin: 2rem 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .post-article__body :global(code) {
    font-family: 'Fira Code', 'JetBrains Mono', monospace;
  }

  .post-article__body :global(p code) {
    background: var(--color-surface);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9em;
    color: var(--color-accent);
  }

  .post-article__body :global(ul),
  .post-article__body :global(ol) {
    margin: 1.5rem 0;
    padding-left: 0;
  }

  .post-article__body :global(li) {
    position: relative;
    padding-left: 2rem;
    margin-bottom: 1rem;
  }

  .post-article__body :global(ul li::before) {
    content: '';
    position: absolute;
    left: 0;
    top: 0.6em;
    width: 8px;
    height: 8px;
    background: var(--color-accent);
    border-radius: 50%;
  }

  .post-article__body :global(strong) {
    font-weight: 600;
    color: var(--color-text);
  }

  .post-article__body :global(img) {
    width: 100%;
    border-radius: var(--card-radius);
    margin: 2rem 0;
  }

  .post-article__body :global(a) {
    color: var(--color-accent);
    text-decoration: none;
  }

  .post-article__body :global(a:hover) {
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  /* ===================== SIDEBAR ===================== */
  .post-sidebar {
    position: sticky;
    top: 100px;
    height: fit-content;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .author-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--card-radius);
    padding: 2rem;
    text-align: center;
  }

  .author-card__avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-accent) 0%, #6366f1 100%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 2rem;
    margin: 0 auto 1rem;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
  }

  .author-card__avatar--img {
    object-fit: cover;
    background: none;
  }

  .author-card__name {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1.15rem;
    color: var(--color-text);
  }

  .author-card__role {
    color: var(--color-accent);
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 0.25rem;
  }

  .author-card__bio {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    margin-top: 1rem;
    line-height: 1.6;
  }

  .author-card__socials {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 1.25rem;
  }

  .author-card__socials a {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    transition: all 0.2s ease;
  }

  .author-card__socials a:hover {
    background: var(--color-accent);
    color: #fff;
    transform: translateY(-2px);
  }

  /* Table of Contents */
  .toc-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--card-radius);
    padding: 1.5rem;
  }

  .toc-card__title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-heading);
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .toc-card__nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toc-card__nav :global(a) {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-sm);
    transition: all 0.2s;
    border-left: 2px solid transparent;
  }

  .toc-card__nav :global(a:hover) {
    color: var(--color-text);
    background: var(--color-surface);
    border-left-color: var(--color-accent);
  }

  /* ===================== POST FOOTER ===================== */
  .post-footer {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .post-footer__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding: 2rem 0;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .post-tag {
    padding: 0.5rem 1rem;
    background: var(--color-surface);
    border-radius: var(--radius-pill);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    transition: all 0.2s;
  }

  .post-tag:hover {
    background: var(--color-accent);
    color: #fff;
  }

  .post-share {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .post-share__label {
    font-weight: 600;
    color: var(--color-text);
    font-size: 0.95rem;
  }

  .post-share__buttons {
    display: flex;
    gap: 0.5rem;
  }

  .post-share__btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    background: var(--color-bg-card);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
  }

  .post-share__btn:hover {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: #fff;
    transform: translateY(-2px);
  }

  /* ===================== RELATED ARTICLES ===================== */
  .related-articles {
    background: var(--color-bg-alt);
    padding: 4rem 0;
    margin-top: 4rem;
  }

  .related-articles__title {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: var(--color-text);
  }

  .related-articles__grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  /* ===================== RESPONSIVE ===================== */
  @media (max-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .post-sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
    }

    .author-card,
    .toc-card {
      flex: 1;
      min-width: 280px;
    }

    .related-articles__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .post-hero {
      height: 60vh;
      min-height: 400px;
    }

    .post-hero__container {
      padding: 2rem 1.5rem;
    }

    .post-hero__title {
      font-size: 1.75rem;
    }

    .post-hero__meta {
      font-size: 0.85rem;
      gap: 0.75rem;
    }

    .post-layout {
      padding: 2rem 1.5rem;
    }

    .post-sidebar {
      flex-direction: column;
    }

    .author-card,
    .toc-card {
      min-width: 100%;
    }

    .post-footer__inner {
      flex-direction: column;
      align-items: flex-start;
    }

    .related-articles__grid {
      grid-template-columns: 1fr;
    }

    .related-articles {
      padding: 3rem 0;
    }
  }
</style>

<script>
  // Generate Table of Contents
  document.addEventListener('DOMContentLoaded', () => {
    const article = document.querySelector('.post-article__body');
    const tocNav = document.getElementById('tableOfContents');

    if (article && tocNav) {
      const headings = article.querySelectorAll('h2');

      headings.forEach((heading, index) => {
        const id = `section-${index}`;
        heading.id = id;

        const link = document.createElement('a');
        link.href = `#${id}`;
        link.textContent = heading.textContent;
        tocNav.appendChild(link);
      });
    }

    // Share buttons
    const shareButtons = document.querySelectorAll('[data-share]');
    const pageUrl = encodeURIComponent(window.location.href);
    const pageTitle = encodeURIComponent(document.title);

    shareButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.getAttribute('data-share');
        let shareUrl = '';

        switch (type) {
          case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?url=${pageUrl}&text=${pageTitle}`;
            break;
          case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`;
            break;
          case 'copy':
            navigator.clipboard.writeText(window.location.href);
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            setTimeout(() => {
              btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
            }, 2000);
            return;
        }

        if (shareUrl) {
          window.open(shareUrl, '_blank', 'width=600,height=400');
        }
      });
    });
  });
</script>
